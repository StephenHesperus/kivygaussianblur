#: import rgba utils.rgba
#: import SlideTransition kivy.uix.screenmanager.SlideTransition
#: import expanduser os.path.expanduser


<Toolbar@RelativeLayout, ControlPanel@BoxLayout>:
    size_hint: 1, None
    height: '64dp'
    canvas:
        Color:
            rgba: rgba(224, 224, 224)
        Rectangle:
            size: self.size

<DarkToolbar@RelativeLayout>:
    size_hint: 1, None
    height: '64dp'
    canvas:
        Color:
            rgba: rgba('212121')
        Rectangle:
            size: self.size

<CPLabel@Label>:
    color: 0, 0, 0, .87
    size: self.texture_size
    size_hint: None, 1
    padding_x: '8dp'

<InitScreen@Screen>:
    id: init
    name: 'init'
    canvas:
        Color:
            rgba: rgba('fafafa')
        Rectangle:
            size: self.size


    BoxLayout:
        orientation: 'vertical'

        Toolbar:
            Label:
                text: 'Gaussian Blur App'
                font_size: '20sp'
                bold: True
                color: 0, 0, 0, .87
                text_size: self.size
                valign: 'middle'
                padding_x: '32dp'

        AnchorLayout:
            anchor_x: 'center'
            anchor_y: 'center'

            ImageButton:
                canvas.before:
                    Color:
                        rgba: rgba(189, 189, 189) if self.state == 'normal' else rgba(158, 158, 158)
                    Rectangle:
                        source: './images/folder_open_bg.png'
                        size: 192, 192
                        pos: self.center_x - 192/2, self.center_y - 192/2

                source: './images/folder.png' if self.state == 'normal' else './images/folder_open.png'
                color: (0, 0, 0, .38) if self.state == 'normal' else (0, 0, 0, .54)
                size_hint: None, None
                size: '192dp', '192dp'
                on_release: root.manager.current = 'image_chooser'

<ImageChooserScreen@Screen>:
    name: 'image_chooser'
    canvas:
        Color:
            rgba: rgba('424242')
        Rectangle:
            size: self.size

    BoxLayout:
        orientation: 'vertical'

        DarkToolbar:
            Label:
                text: 'Choose An Image to Blur'
                font_size: '20sp'
                bold: True
                color: 1, 1, 1, 1
                text_size: self.size
                valign: 'middle'
                padding_x: '32dp'

            AnchorLayout:
                anchor_x: 'right'
                anchor_y: 'center'
                padding: 0, 0, '16dp', 0

                BoxLayout:
                    size: '92dp', '42dp'
                    size_hint: None, None
                    spacing: '8dp'

                    ImageButton:
                        source: './images/clear.png'
                        color: (1, 1, 1, .5) if self.state == 'normal' else (1, 1, 1)
                        size: '42dp', '42dp'
                        size_hint: None, None
                        on_release: root.manager.current = 'init'

                    ImageButton:
                        source: './images/done.png'
                        color: (1, 1, 1, .5) if self.state == 'normal' else (1, 1, 1)
                        disabled: not chooser.selection
                        opacity: 0 if self.disabled else 1
                        on_release: root.manager.on_image_choose(chooser.selection[0])
                        size: '42dp', '42dp'
                        size_hint: None, None

        FileChooserListView:
            id: chooser
            path: expanduser('~')
            show_hidden: True
            filters: ['*.png', '*.jpg', '*.jpeg', '*.gif']

<GaussianBlurScreen@Screen>:
    name: 'blur'
    canvas:
        Color:
            rgba: rgba('fafafa')
        Rectangle:
            size: self.size

    RelativeLayout:
        ScatterLayout:
            id: scatter
            size_hint: 1, 1
            auto_bring_to_front: False
            transform: root.manager.image.initial_matrix

            Image:
                id: im
                mipmap: True
                texture: root.manager.image.texture
                opacity: 0.1 if root.manager.blurring else 1

            Indicator:
                opacity: 1 if root.manager.blurring else 0
                reset: not root.manager.blurring


        Toolbar:
            id: toolbar
            pos: 0, str(scatter.height - 64) + 'dp'
            Label:
                text: 'Gaussian Blur App'
                font_size: '20sp'
                bold: True
                color: 0, 0, 0, .87
                text_size: self.size
                valign: 'middle'
                padding_x: '32dp'

            AnchorLayout:
                anchor_x: 'right'
                anchor_y: 'center'
                padding: 0, 0, '16dp', 0

                BoxLayout:
                    size: '92dp', '42dp'
                    size_hint: None, None
                    spacing: '8dp'

                    ImageButton:
                        source: './images/cancel.png'
                        color: (0, 0, 0, .38) if self.state == 'normal' else (0, 0, 0, .54)
                        size: '42dp', '42dp'
                        size_hint: None, None
                        on_release: root.manager.current = 'init'

                    ImageButton:
                        source: './images/save.png'
                        color: (0, 0, 0, .38) if self.state == 'normal' else (0, 0, 0, .54)
                        opacity: 0 if root.manager.saving else 1
                        on_release: root.manager.save()
                        size: '42dp', '42dp'
                        size_hint: None, None

        ControlPanel:
            id: control_panel
            padding: '8dp', 0, '8dp', 0

            CPLabel:
                text: 'Radius'

            Slider:
                # range is multiplied by 10
                id: radius_slider
                range: 0, 10000
                step: 1
                value: root.manager.image.initial_radius
                on_value: root.manager.on_radius_change(self.value / 10)
                size_hint: 1, 1

            TextInput:
                id: radius_input
                text: '%.1f' % (radius_slider.value / 10)
                input_type: 'number'
                input_filter: 'float'
                multiline: False
                on_focus: if not args[1]: radius_slider.value = max(0, min(float(self.text or 0), 1000)) * 10
                foreground_color: 0, 0, 0, .87
                cursor_color: 0, 0, 0, .87
                selection_color: 0, 0, 0, .54
                size_hint: None, 1
                width: '88dp'
                padding: '16dp', '20dp', '16dp', '25dp'
                halign: 'center'
                background_normal: ''
                background_active: ''
                background_color: 0, 0, 0, 0
                canvas.before:
                    Color:
                        rgba: (0, 0, 0, .54) if self.focus else (0, 0, 0, .54)
                    Line:
                        points: (self.x + 14, 16, self.x + self.width - 20, 16)
                        width: 2 if self.focus else 1
                        cap: 'none'

            CheckBox:
                id: alpha
                background_checkbox_normal: './images/checkbox_outline.png'
                background_checkbox_down: './images/checkbox.png'
                disabled: not root.manager.image.has_alpha
                opacity: 0 if self.disabled else 1
                active: True
                on_active: root.manager.use_alpha = self.active; root.manager.on_radius_change(radius_slider.value / 10)
                width: '48dp'
                size_hint: None, 1

            CPLabel:
                text: 'Alpha'
                opacity: 0 if alpha.disabled else 1

<GaussianBlurWindow>:
    transition: SlideTransition()

    InitScreen:
    ImageChooserScreen:
    GaussianBlurScreen:
